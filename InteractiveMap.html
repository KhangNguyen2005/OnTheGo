<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Azure Maps: Address and Amenity Search</title>
  <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.css" />
  <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    /* Top bar for user input */
    #topBar {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      background-color: rgba(255, 255, 255, 0.9);
      padding: 8px;
      z-index: 9999;
      font-family: Arial, sans-serif;
    }
    /* The map container */
    #mapDiv {
      position: relative;
      width: 100%;
      height: 100vh;
    }
  </style>
</head>
<body>
  <!-- Top bar: input for address and amenity -->
  <div id="topBar">
    <input 
      type="text" 
      id="addressInput" 
      placeholder="Enter an address or city..." 
      style="width: 300px; padding: 5px;"
    />
    <button onclick="setLocation()" style="padding: 5px 10px;">Set Location</button>
    <br>
    <input 
      type="text" 
      id="amenityInput" 
      placeholder="Enter an amenity (e.g., coffee, arcade)..." 
      style="width: 300px; padding: 5px; display: none; margin-top: 8px;"
    />
    <button id="amenityButton" onclick="searchByAmenity()" style="padding: 5px 10px; display: none; margin-top: 8px;">Get Recommendations</button>
  </div>

  <!-- Map container -->
  <div id="mapDiv"></div>

  <script>
    let map, datasource, symbolLayer;
    let hoverPopup;

    function initMap() {
      map = new atlas.Map('mapDiv', {
        authOptions: {
          authType: 'subscriptionKey',
          subscriptionKey: '9FeaTsMg7fH5DgcchS5AtICBBNTWnuoBHNG4H0a3OLzkxTeY9lHnJQQJ99BCACYeBjF6fAFpAAAgAZMP2bXk' 
        }
      });

      map.events.add('ready', function () {
        datasource = new atlas.source.DataSource();
        map.sources.add(datasource);

        symbolLayer = new atlas.layer.SymbolLayer(datasource, null, {
          iconOptions: {
            image: [
              'case',
              ['==', ['get', 'markerType'], 'selected'],
              'pin-round-blue',
              'pin-round-red'
            ],
            allowOverlap: true
          },
          textOptions: {
            textField: ['get', 'title'],
            offset: [0, 1.2]
          }
        });
        map.layers.add(symbolLayer);

        hoverPopup = new atlas.Popup({
          closeButton: false,
          pixelOffset: [0, -30]
        });

        // Allow user to set a location by clicking the map
        map.events.add('click', function (e) {
          const coords = e.position; // [lng, lat]
          datasource.clear();
          hoverPopup.close();

          datasource.add(new atlas.data.Feature(
            new atlas.data.Point(coords),
            { markerType: 'selected', title: 'Selected Location' }
          ));

          map.setCamera({ center: coords, zoom: 14 });
          document.getElementById('amenityInput').style.display = 'inline';
          document.getElementById('amenityButton').style.display = 'inline';
        });

        map.events.add('mouseenter', symbolLayer, function (e) {
          if (e.shapes && e.shapes.length > 0) {
            const shape = e.shapes[0];
            const props = shape.getProperties();
            if (props.markerType === 'recommended') {
              const contentHTML = `
                <div style="font-family: Arial, sans-serif;">
                  <strong>${props.title || 'N/A'}</strong><br>
                  Address: ${props.address || 'N/A'}<br>
                  Rating: ${props.rating || 'N/A'}<br>
                  Price: ${props.price || 'N/A'}<br>
                  Hours: ${props.hours || 'N/A'}
                </div>
              `;
              hoverPopup.setOptions({
                content: contentHTML,
                position: shape.getCoordinates()
              });
              hoverPopup.open(map);
            }
          }
        });

        map.events.add('mouseleave', symbolLayer, function () {
          hoverPopup.close();
        });

        // Clicking a recommended spot should only draw the route, NOT update the selected location
        map.events.add('click', symbolLayer, function (e) {
          if (e.shapes && e.shapes.length > 0) {
            const shape = e.shapes[0];
            const props = shape.getProperties();
            
            if (props.markerType === 'recommended') {
              const destination = shape.getCoordinates();
              
              const selectedFeatures = datasource.getShapes().filter(shape => shape.getProperties().markerType === 'selected');
              
              if (selectedFeatures.length === 0) {
                alert("Please select a starting location first.");
                return;
              }

              const startLocation = selectedFeatures[0].getCoordinates();
              
              drawRoute(startLocation, destination);
            }
          }
        });
      });
    }

    // Geocode the provided address using Azure Maps
    function getCoordinates(query) {
      const subKey = '9FeaTsMg7fH5DgcchS5AtICBBNTWnuoBHNG4H0a3OLzkxTeY9lHnJQQJ99BCACYeBjF6fAFpAAAgAZMP2bXk'; 
      const addressUrl = `https://atlas.microsoft.com/search/address/json?api-version=1.0&subscription-key=${subKey}&query=${encodeURIComponent(query)}`;
      
      return fetch(addressUrl)
        .then(resp => resp.json())
        .then(data => {
          if (data && data.results && data.results.length > 0) {
            const best = data.results[0];
            return { lat: best.position.lat, lon: best.position.lon };
          } else {
            // Fallback: try fuzzy search
            const fuzzyUrl = `https://atlas.microsoft.com/search/fuzzy/json?api-version=1.0&subscription-key=${subKey}&query=${encodeURIComponent(query)}&limit=1`;
            return fetch(fuzzyUrl)
              .then(resp2 => resp2.json())
              .then(data2 => {
                if (data2 && data2.results && data2.results.length > 0) {
                  const best2 = data2.results[0];
                  return { lat: best2.position.lat, lon: best2.position.lon };
                }
                return null;
              });
          }
        })
        .catch(err => {
          console.error("Error during geocoding:", err);
          return null;
        });
    }

    function setLocation() {
      const address = document.getElementById('addressInput').value.trim();
      if (!address) {
        alert("Please enter an address or city.");
        return;
      }
      
      getCoordinates(address).then(result => {
        if (result) {
          const { lat, lon } = result;
          console.log("Geocoded lat/lon:", lat, lon);
          datasource.clear();
          hoverPopup.close();
          
          const coords = [lon, lat];
          datasource.add(new atlas.data.Feature(
            new atlas.data.Point(coords),
            { markerType: 'selected', title: 'Selected Location' }
          ));

          map.setCamera({ center: coords, zoom: 14 });
          
          document.getElementById('amenityInput').style.display = 'inline';
          document.getElementById('amenityButton').style.display = 'inline';
        } else {
          alert("No matching address found. Please refine your input.");
        }
      });
    }

    function searchByAmenity() {
      const amenity = document.getElementById('amenityInput').value.trim();
      if (!amenity) {
        alert("Please enter an amenity, e.g., coffee, arcade.");
        return;
      }

      const selectedFeatures = datasource.getShapes().filter(shape => shape.getProperties().markerType === 'selected');
      if (selectedFeatures.length === 0) {
        alert("Please set a location first.");
        return;
      }
      const coords = selectedFeatures[0].getCoordinates();

      fetchRecommendations(coords[1], coords[0], amenity);
    }

    function fetchRecommendations(lat, lon, amenity) {
      // Update the fetch call to point to the new /fetching_data endpoint
      fetch('http://127.0.0.1:5000/fetching_data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ latitude: lat, longitude: lon, amenity: amenity })
      })
      .then(resp => resp.json())
      .then(data => {
        if (data.error) {
          console.error("Error from /fetching_data:", data.error);
          return;
        }

        data.forEach(item => {
          datasource.add(new atlas.data.Feature(
            new atlas.data.Point([item.Longitude, item.Latitude]),
            {
              markerType: 'recommended',
              title: item.Name || 'N/A',
              address: item.Address || 'N/A',
              rating: item.Rating || 'N/A',
              price: item.Price || 'N/A',
              hours: item["Opening Hour"] || 'N/A'
            }
          ));
        });

        map.setCamera({
          bounds: atlas.data.BoundingBox.fromData(datasource.getShapes()),
          padding: 50
        });
      })
      .catch(err => console.error("Error fetching recommendations:", err));
    }

    function drawRoute(start, end) {
      const key = '9FeaTsMg7fH5DgcchS5AtICBBNTWnuoBHNG4H0a3OLzkxTeY9lHnJQQJ99BCACYeBjF6fAFpAAAgAZMP2bXk';
      const routeUrl = `https://atlas.microsoft.com/route/directions/json?api-version=1.0&subscription-key=${key}&query=${start[1]},${start[0]}:${end[1]},${end[0]}`;

      fetch(routeUrl)
        .then(response => response.json())
        .then(data => {
          if (data.routes && data.routes.length > 0) {
            const coordinates = data.routes[0].legs[0].points.map(p => [p.longitude, p.latitude]);

            if (routeLayer) {
              map.layers.remove(routeLayer);
            }

            const routeSource = new atlas.source.DataSource();
            routeSource.add(new atlas.data.LineString(coordinates));
            map.sources.add(routeSource);

            routeLayer = new atlas.layer.LineLayer(routeSource, null, {
              strokeColor: 'green',
              strokeWidth: 5
            });

            map.layers.add(routeLayer);
          } else {
            alert("No route found.");
          }
        })
        .catch(error => console.error("Error fetching route:", error));
    }

    window.onload = initMap;
  </script>
</body>
</html>
